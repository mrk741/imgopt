<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Background Remover • Bulk Image Optimizer</title>
  <link rel="icon" href="data:;base64,=" />
  <style>
    :root { --bg:#0b0d12; --card:#131722; --ink:#e8ecf1; --muted:#9aa4b2; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter;background:var(--bg);color:var(--ink)}
    a{color:#4b82ff;text-decoration:none}
    header{padding:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;background:#0f1320;border-bottom:1px solid #1e2332}
    header h1{margin:0;font-size:20px;font-weight:700}
    nav a{margin-left:16px;font-size:14px;color:var(--muted)}
    .wrap{max-width:1100px;margin:0 auto;padding:0 18px 60px}
    .card{background:var(--card);border:1px solid #20283a;border-radius:18px;padding:18px;margin-top:18px}
    .grid{display:grid;gap:18px;grid-template-columns:1fr}
    @media(min-width:980px){.grid{grid-template-columns:420px 1fr}}
    .drop{border:1.5px dashed #33415c;border-radius:14px;padding:18px;text-align:center;color:var(--muted);cursor:pointer}
    .btn{background:#2b6ef3;color:#fff;border:0;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .controls{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    .controls label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .thumbs{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
    .thumb{background:#0f1320;border:1px solid #20283a;border-radius:12px;padding:10px;display:grid;gap:8px}
    .thumb img{width:100%;height:120px;object-fit:contain;background:#0b0f1a;border-radius:8px}
    .bar{height:6px;background:#111727;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;width:0%;background:#2b6ef3;transition:width .25s ease}
    .muted{color:var(--muted);font-size:12px}
    select,input[type=number],input[type=range]{background:#0f1320;border:1px solid #20283a;color:var(--ink);border-radius:10px;padding:8px 10px}
    #qualityVal{font-weight:600;margin-left:6px;color:#4b82ff}
    .footer{margin-top:12px;color:#7c8798;font-size:12px;text-align:center}
    .tag{font-size:11px;background:#0d1220;border:1px solid #1d2740;color:#a6b0c0;padding:2px 6px;border-radius:999px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <h1>Background Remover + Bulk Optimizer</h1>
    <nav>
      <a href="about.html">About</a>
      <a href="help.html">Help</a>
    </nav>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="drop" id="drop">
          <p><strong>Drop images here</strong> or click to browse</p>
          <input id="file" type="file" accept="image/*" multiple class="hidden" />
          <p class="muted">PNG, JPG, WebP, AVIF • all processed locally</p>
        </div>

        <hr style="border:0;border-top:1px solid #20283a;margin:18px 0" />

        <div class="controls">
          <label>Max width (px)
            <input type="number" id="maxWidth" min="64" step="16" value="1600" />
          </label>
          <label>Max height (px)
            <input type="number" id="maxHeight" min="64" step="16" value="1600" />
          </label>
          <label>Output format
            <select id="format">
              <option value="webp">WebP</option>
              <option value="avif">AVIF</option>
              <option value="jpeg">JPEG</option>
              <option value="png">PNG</option>
            </select>
          </label>
          <label>Quality
            <input type="range" id="quality" min="1" max="100" value="82" />
            <span id="qualityVal">82%</span>
          </label>
          <label>Background removal
            <select id="bgMode">
              <option value="people" selected>People (on-device)</option>
              <option value="none">Disabled</option>
            </select>
          </label>
          <label>Canvas color (if not transparent)
            <input type="color" id="canvasColor" value="#000000" />
          </label>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="runBtn" disabled>Process Images</button>
          <button class="btn" id="zipBtn" disabled>Download ZIP</button>
          <button class="btn" id="clearBtn">Clear Queue</button>
        </div>
        <p class="muted">All work happens in your browser. Nothing is uploaded.</p>

        <div class="footer">
          <span class="tag">MediaPipe</span>
          <span class="tag">Squoosh Codecs</span>
          <span class="tag">JSZip</span>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <strong>Queue</strong>
          <span class="muted" id="count">0 items</span>
        </div>
        <div class="bar" style="margin:10px 0 14px"><i id="prog"></i></div>
        <div class="thumbs" id="thumbs"></div>
      </div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
  <script type="module">
    import { ImagePool } from "https://esm.run/@squoosh/lib";

    const $ = id => document.getElementById(id);
    const fileInput = $("file"), drop = $("drop"), runBtn = $("runBtn"), zipBtn = $("zipBtn"),
          clearBtn = $("clearBtn"), thumbs = $("thumbs"), prog = $("prog"), countEl = $("count"),
          maxWidth = $("maxWidth"), maxHeight = $("maxHeight"), formatSel = $("format"),
          quality = $("quality"), qualityVal = $("qualityVal"),
          bgMode = $("bgMode"), canvasColor = $("canvasColor");

    let files = [], results = [], zip;
    let selfieSeg = null;

    // Quality label
    quality.addEventListener("input", ()=> qualityVal.textContent = quality.value + "%");

    // Drag/drop
    const accept = items => {
      files = [...files, ...Array.from(items).filter(f => /^image\\//.test(f.type))];
      countEl.textContent = files.length + " items";
      runBtn.disabled = files.length === 0;
      renderQueue();
    };
    fileInput.addEventListener("change", e=> accept(e.target.files));
    ["dragenter","dragover"].forEach(ev=> drop.addEventListener(ev,e=>{e.preventDefault(); drop.style.borderColor="#2b6ef3"}));
    ["dragleave","drop"].forEach(ev=> drop.addEventListener(ev,e=>{e.preventDefault(); drop.style.borderColor="#33415c"}));
    drop.addEventListener("drop", e=> accept(e.dataTransfer.files));
    drop.addEventListener("click", ()=> fileInput.click());

    clearBtn.onclick = ()=>{ files=[]; thumbs.innerHTML=\"\"; countEl.textContent=\"0 items\"; runBtn.disabled=true; zipBtn.disabled=true; prog.style.width=\"0%\"; };

    function renderQueue(){
      thumbs.innerHTML = files.map((f,i)=>`
        <div class='thumb'><img id='img-${i}'/><div class='muted'>${f.name}</div><div class='muted' id='status-${i}'>Queued</div></div>
      `).join('');
      files.forEach((f,i)=>{
        const reader = new FileReader();
        reader.onload = ()=>{ const img=$('img-'+i); if(img) img.src=reader.result; };
        reader.readAsDataURL(f);
      });
    }

    // Background removal
    selfieSeg = new SelfieSegmentation({ locateFile: f => "https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/"+f });
    selfieSeg.setOptions({ modelSelection:1 });
    await selfieSeg.initialize();

    async function removeBg(imageBitmap){
      return new Promise(resolve=>{
        const w=imageBitmap.width,h=imageBitmap.height;
        const src=document.createElement("canvas"); src.width=w;src.height=h;
        const ctx=src.getContext("2d"); ctx.drawImage(imageBitmap,0,0);
        selfieSeg.onResults(res=>{
          const c=document.createElement("canvas"); c.width=w;c.height=h;
          const cc=c.getContext("2d"); cc.drawImage(res.segmentationMask,0,0,w,h);
          const mask=cc.getImageData(0,0,w,h);
          const imgData=ctx.getImageData(0,0,w,h); const p=imgData.data,m=mask.data,t=128;
          for(let i=0;i<p.length;i+=4){ p[i+3]=(m[i]>t)?255:0; }
          ctx.putImageData(imgData,0,0); resolve(src);
        });
        selfieSeg.send({ image:imageBitmap });
      });
    }

    const pool = new ImagePool(navigator.hardwareConcurrency || 4);

    async function encodeWithSquoosh(canvas,targetFmt,q,maxW,maxH){
      const bmp=await createImageBitmap(canvas);
      let {width:w,height:h}=bmp; const r=Math.min(maxW/w,maxH/h,1);
      w=Math.round(w*r);h=Math.round(h*r);
      const work=document.createElement("canvas"); work.width=w;work.height=h;
      const c=work.getContext("2d"); c.imageSmoothingQuality="high"; c.drawImage(bmp,0,0,w,h);
      const image=pool.ingestImage(await work.convertToBlob({type:'image/png'}));
      const enc={ jpeg:{encoderName:'mozjpeg',encodeOptions:{quality:q}},
                  webp:{encoderName:'webp',encodeOptions:{quality:q}},
                  avif:{encoderName:'avif',encodeOptions:{cqLevel:Math.round(63-(q/100)*63)}},
                  png:{encoderName:'oxipng',encodeOptions:{level:3}} };
      await image.encode(enc[targetFmt]); const encoded=image.encodedWith[enc[targetFmt].encoderName];
      return new Blob([encoded.binary],{type:`image/${targetFmt==='jpeg'?'jpeg':targetFmt}`});
    }

    runBtn.addEventListener("click", async ()=>{
      if(!files.length) return;
      runBtn.disabled=true; zipBtn.disabled=true; results=[]; zip=new JSZip(); prog.style.width='0%';
      const maxW=+maxWidth.value,maxH=+maxHeight.value,outFmt=formatSel.value,q=+quality.value; 
      const doBg=bgMode.value!=='none'; let done=0;
      for(const [i,f] of files.entries()){
        const st=$('status-'+i);
        try{
          st.textContent='Reading…'; const bmp=await createImageBitmap(f);
          let canvas=document.createElement('canvas'); canvas.width=bmp.width;canvas.height=bmp.height;
          const ctx=canvas.getContext('2d'); ctx.drawImage(bmp,0,0);
          if(doBg){ st.textContent='Removing background…'; canvas=await removeBg(bmp); }
          st.textContent='Optimizing…';
          const blob=await encodeWithSquoosh(canvas,outFmt,q,maxW,maxH);
          zip.file(f.name,blob);
          st.textContent='Done';
        }catch(e){console.error(e);st.textContent='Failed';}
        finally{done++;prog.style.width=((done/files.length)*100).toFixed(1)+'%';}
      }
      zipBtn.disabled=false; runBtn.disabled=false; await pool.close();
    });

    zipBtn.addEventListener("click", async ()=>{
      if(!zip) return; const blob=await zip.generateAsync({type:'blob'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url;a.download='optimized-images.zip';a.click();URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>