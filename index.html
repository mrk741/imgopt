<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Background Remover â€¢ Bulk Image Optimizer</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b0d12">
  <style>
    :root { --bg:#0b0d12; --card:#131722; --ink:#e8ecf1; --muted:#9aa4b2; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter;background:var(--bg);color:var(--ink)}
    header{padding:20px;display:flex;align-items:center;justify-content:space-between;background:#0f1320;border-bottom:1px solid #1e2332}
    header h1{margin:0;font-size:20px;font-weight:700}
    nav a{margin-left:16px;color:var(--muted);font-size:14px;text-decoration:none}
    .btn{background:#2b6ef3;color:#fff;border:0;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .wrap{max-width:1100px;margin:0 auto;padding:0 18px 60px}
    .card{background:var(--card);border:1px solid #20283a;border-radius:18px;padding:18px;margin-top:18px}
    .grid{display:grid;gap:18px;grid-template-columns:1fr}
    @media(min-width:980px){.grid{grid-template-columns:420px 1fr}}
    .drop{border:1.5px dashed #33415c;border-radius:14px;padding:18px;text-align:center;color:var(--muted);cursor:pointer}
    .controls{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    .controls label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    .fullrow{grid-column:1/-1;display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .check{display:flex;align-items:center;gap:8px;font-size:13px}
    .thumbs{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
    .thumb{background:#0f1320;border:1px solid #20283a;border-radius:12px;padding:10px;display:grid;gap:8px}
    .thumb img{width:100%;height:120px;object-fit:contain;background:#0b0f1a;border-radius:8px}
    .bar{height:6px;background:#111727;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;width:0%;background:#2b6ef3;transition:width .25s ease}
    .muted{color:var(--muted);font-size:12px}
    select,input[type=number],input[type=range],input[type=color]{background:#0f1320;border:1px solid #20283a;color:var(--ink);border-radius:10px;padding:8px 10px}
    #qualityVal{font-weight:600;margin-left:6px;color:#4b82ff}
  </style>
</head>
<body>
  <header>
    <h1>Background Remover + Bulk Optimizer</h1>
    <nav>
      <a href="about.html">About</a>
      <a href="help.html">Help</a>
    </nav>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="drop" id="drop">
          <p><strong>Drop images here</strong> or click to browse</p>
          <input id="file" type="file" accept="image/*" multiple class="hidden" />
          <p class="muted">PNG, JPG, WebP, AVIF, GIF, BMP, HEIC/HEIF, TIFF</p>
        </div>

        <hr style="border:0;border-top:1px solid #20283a;margin:18px 0" />

        <div class="controls">
          <div class="fullrow">
            <label class="check"><input type="checkbox" id="enableResize" /> <span>Enable resizing</span></label>
            <label class="check"><input type="checkbox" id="forceOpaque" /> <span>Force opaque output</span></label>
          </div>

          <label>Max width (px)
            <input type="number" id="maxWidth" value="1600" disabled />
          </label>
          <label>Max height (px)
            <input type="number" id="maxHeight" value="1600" disabled />
          </label>

          <label>Output format
            <select id="format">
              <option value="keep">Keep original</option>
              <option value="webp" selected>WebP</option>
              <option value="avif">AVIF</option>
              <option value="jpeg">JPEG</option>
              <option value="png">PNG</option>
            </select>
          </label>
          <label>Quality
            <input type="range" id="quality" min="1" max="100" value="70" />
            <span id="qualityVal">70%</span>
          </label>

          <label>Background removal
            <select id="bgMode">
              <option value="none" selected>Disabled</option>
              <option value="people">People (fast)</option>
              <option value="people_refine">People + refine</option>
            </select>
          </label>
          <label>Canvas color
            <input type="color" id="canvasColor" value="#000000" />
          </label>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="runBtn" disabled>Process Images</button>
          <button class="btn" id="zipBtn" disabled>Download ZIP</button>
          <button class="btn" id="allBtn" disabled>Download Images</button>
          <button class="btn" id="clearBtn">Clear Queue</button>
        </div>
        <p class="muted">Everything runs locally in your browser.</p>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <strong>Queue</strong>
          <span class="muted" id="count">0 items</span>
        </div>
        <div class="bar"><i id="prog"></i></div>
        <div class="thumbs" id="thumbs"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const fileInput = $('file');
    const drop = $('drop');
    const runBtn = $('runBtn');
    const zipBtn = $('zipBtn');
    const allBtn = $('allBtn');
    const clearBtn = $('clearBtn');
    const thumbs = $('thumbs');
    const prog = $('prog');
    const countEl = $('count');
    const enableResize = $('enableResize');
    const maxWidth = $('maxWidth');
    const maxHeight = $('maxHeight');
    const formatSel = $('format');
    const quality = $('quality');
    const qualityVal = $('qualityVal');
    const bgMode = $('bgMode');
    const canvasColor = $('canvasColor');
    const forceOpaque = $('forceOpaque');

    let files = [];
    let zip = null;
    let processed = [];

    quality.addEventListener('input', ()=> qualityVal.textContent = quality.value + '%');
    enableResize.addEventListener('change', ()=>{
      const dis = !enableResize.checked;
      maxWidth.disabled = dis;
      maxHeight.disabled = dis;
    });

    function accept(items){
      const imgs = Array.from(items).filter(f=>/^image\//.test(f.type));
      if(!imgs.length){ alert('No images detected'); return;}
      files = files.concat(imgs);
      countEl.textContent = files.length+' items';
      runBtn.disabled = files.length===0;
      renderQueue();
    }

    fileInput.addEventListener('change', e=>accept(e.target.files));
    drop.addEventListener('click', ()=>fileInput.click());
    ['dragenter','dragover','dragleave','drop'].forEach(ev=>{
      drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();});
    });
    drop.addEventListener('drop', e=>accept(e.dataTransfer.files));

    clearBtn.addEventListener('click', ()=>{
      files=[];processed=[];thumbs.innerHTML='';countEl.textContent='0 items';
      runBtn.disabled=zipBtn.disabled=allBtn.disabled=true;prog.style.width='0%';
    });

    function renderQueue(){
      thumbs.innerHTML = files.map((f,i)=>`
        <div class='thumb'>
          <img id='img-${i}' alt='preview'/>
          <div class='muted'>${f.name}</div>
          <div class='muted' id='status-${i}'>Queued</div>
        </div>`).join('');
      files.forEach((f,i)=>{
        const r=new FileReader();
        r.onload=()=>{$('img-'+i).src=r.result;};
        r.readAsDataURL(f);
      });
    }

    async function loadImage(f){
      return new Promise((res,rej)=>{
        const url=URL.createObjectURL(f);
        const img=new Image();
        img.onload=()=>{URL.revokeObjectURL(url);res(img);}
        img.onerror=()=>rej();
        img.src=url;
      });
    }

    function fitSize(w,h,maxW,maxH){const r=Math.min(maxW/w,maxH/h,1);return {w:Math.round(w*r),h:Math.round(h*r)};}
    function encodeCanvas(c,type,q){const m=type==='jpeg'?'image/jpeg':type==='png'?'image/png':type==='avif'?'image/avif':'image/webp';return new Promise(r=>c.toBlob(b=>r(b),m,q));}

    runBtn.addEventListener('click', async ()=>{
      if(!files.length) return;
      runBtn.disabled=zipBtn.disabled=allBtn.disabled=true;
      prog.style.width='0%';
      zip=new JSZip(); processed=[];
      const resize=enableResize.checked; const q=parseInt(quality.value)/100;
      const fmt=formatSel.value;

      for(let i=0;i<files.length;i++){
        const f=files[i]; const st=$('status-'+i);
        try{
          st.textContent='Reading...';
          const img=await loadImage(f);
          const c=document.createElement('canvas');const ctx=c.getContext('2d');
          c.width=img.width;c.height=img.height;ctx.drawImage(img,0,0);

          let out=c;
          if(resize){
            const s=fitSize(img.width,img.height,parseInt(maxWidth.value),parseInt(maxHeight.value));
            const cc=document.createElement('canvas');cc.width=s.w;cc.height=s.h;cc.getContext('2d').drawImage(c,0,0,s.w,s.h);
            out=cc;
          }

          const opaque=(fmt==='jpeg')||forceOpaque.checked;
          if(opaque){const solid=document.createElement('canvas');solid.width=out.width;solid.height=out.height;
            const sctx=solid.getContext('2d');sctx.fillStyle=canvasColor.value;sctx.fillRect(0,0,solid.width,solid.height);
            sctx.drawImage(out,0,0);out=solid;}

          const outFmt = fmt==='keep'?f.type.split('/')[1]||'png':fmt;
          st.textContent='Encoding...';
          const blob=await encodeCanvas(out,outFmt,q);
          const url=URL.createObjectURL(blob);
          processed.push({name:f.name.replace(/\.[^.]+$/,'')+'.'+outFmt,blob,url});
          zip.file(f.name.replace(/\.[^.]+$/,'')+'.'+outFmt,blob);
          st.textContent='Done';
        }catch(e){st.textContent='Failed';}
        prog.style.width=((i+1)/files.length*100)+'%';
      }

      runBtn.disabled=false; zipBtn.disabled=false; allBtn.disabled=false;
    });

    zipBtn.addEventListener('click', async ()=>{
      if(!zip)return;
      const blob=await zip.generateAsync({type:'blob'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='optimized-images.zip';a.click();
      URL.revokeObjectURL(url);
    });

    allBtn.addEventListener('click', ()=>{
      if(!processed.length)return;
      processed.forEach(p=>{
        const a=document.createElement('a');
        a.href=p.url;a.download=p.name;document.body.appendChild(a);
        a.click();a.remove();
      });
    });
  </script>
</body>
</html>